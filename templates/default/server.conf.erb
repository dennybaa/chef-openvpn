# OpenVPN server config file
#
# Generated by Chef - local changes will be overwritten

<%= "local #{@config[:local]}\n" if @config[:local] -%>
port  <%= @config[:port] %>
proto <%= @config[:proto] %>
dev <%= @config[:dev] %>

<% if @config[:topology] -%>
topology <%= @config[:topology] %>
<% if @config[:topology] == "topology" || @config[:topology] == "p2p"-%>
push <%= "topology #{@config[:topology]}" %>
<% end -%>
<% end -%>

<% if @config[:auth][:type] == "cert_passwd" || @config[:auth][:type] == "passwd" -%>
auth-user-pass-verify /etc/openvpn/<%= @config_name %>/auth.rb via-file
<% end -%>

<% if @config[:auth][:type] == "passwd" -%>
client-cert-not-required
username-as-common-name
<% end -%>

<% if @config[:script_security] -%>
script-security <%= @config[:script_security] %>
<% end -%>

<% if @config[:use_client_connect] -%>
client-connect  /etc/openvpn/<%= @config_name %>/client-connect.sh
<% end -%>
client-config-dir /etc/openvpn/<%= @config_name %>/ccd

ca   /etc/openvpn/<%= @config_name %>/<%= @config_name %>-ca.crt
cert /etc/openvpn/<%= @config_name %>/<%= @config_name %>.crt
key  /etc/openvpn/<%= @config_name %>/<%= @config_name %>.key
dh   /etc/openvpn/<%= @config_name %>/<%= @config_name %>-dh.pem

<% if @config[:auth][:type] != "passwd" && ! @config[:allow_duplicate_cn] -%>
ifconfig-pool-persist /etc/openvpn/<%= @config_name %>/<%= @config_name %>.ipp
<% end -%>

<% if @config[:mode] == "routed" -%>
<%= "server #{@config[:subnet]} #{@config[:netmask]}" if @config[:subnet] %>
<%= "server-ipv6 #{@config[:subnet6]}" if @config[:subnet6] %>
<% end -%>
<% if @config[:mode] == "bridged" -%>
<%= "server-bridge #{@config[:server_ip]} #{@config[:netmask]} #{@config[:dhcp_start]} #{@config[:dhcp_end]}" %>
<% end -%>

<% (@config[:routes] || []).each do |route| -%>
<%= "route #{route}" %>
<% end -%>
<% unless @config[:use_client_connect] -%>
<%= "push \"redirect-gateway #{@config[:redirect_gateway]}\"\n" if @config[:redirect_gateway] -%>
<%= "push \"dhcp-option DNS #{@config[:push_dns_server]}\"\n" if @config[:push_dns_server] -%>
<% (@config[:push] || []).each do |directive| -%>
<%= "push \"#{directive}\"" %>
<% end -%>
<% end -%>
<%= "duplicate-cn\n" if @config[:allow_duplicate_cn] -%>
<%= "client-to-client\n" if @config[:allow_client_to_client] -%>
<%= "keepalive #{@config[:keepalive_interval]} #{@config[:keepalive_timeout]}\n" if @config[:keepalive_interval] and @config[:keepalive_timeout] -%>
<%= "comp-lzo\n" if @config[:comp_lzo] -%>
<%= "tls-cipher #{@config[:tls_cipher_algos]}\n" if @config[:tls_cipher_algos] -%>
<%= "cipher #{@config[:cipher_algo]}\n" if @config[:cipher_algo] -%>
<%= "keysize #{@config[:keysize]}\n" if @config[:keysize] -%>
<%= "auth #{@config[:auth_algo]}\n" if @config[:auth_algo] -%>

user <%= @config[:user] || "openvpn" %>
group <%= @config[:user] || "openvpn" %>

persist-key
persist-tun

tmp-dir /tmp
status /var/log/openvpn/<%= @config_name %>-status.log
log-append /var/log/openvpn/<%= @config_name %>.log
verb 3
mute 20
